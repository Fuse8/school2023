<p align="center">
  <img src="/assets/logo.png" alt="logo" title="Летняя стажировка fuse8/byteminds"/>
</p>

# Задание к уроку №9

## Завернуть PetProject в Docker
- Добавить Dockerfile для проектов `InternalApi` и `PublicApi`
- В Dockerfile-ах должно быть реализовано кэширование нугет пакетов с помощью `dotnet-subset`
- Добавить `.dockerignore` файл
- Добавить файл для docker compose
  - Описать в нем сборку двух сервисов `InternalApi` и `PublicApi`
  - Добавить `service` с базой данных
  - Использовать переменные из файла `.env`


## InternalApi
### Реализовать пересчет кэша относительно другой базовой валюты
- Создать таблицу для хранения задач для пересчета кэша `CacheTask` (название можно выбрать свое)
  - В качестве идентификатора задачи должен использоваться Guid
  - `CacheTask` должен хранить текущий статус задачи
  - Список возможных статусов 
    - `Задача создана`
    - `Задача в обработке`
    - `Задача завершена успешно`
    - `Задача завершена с ошибкой`
    - `Задача отменена`
- Добавить метод в REST-Api для пересчета кэша валют относительно новой базовой валюты
  - Должен принимать в качестве параметра новую базовую валюту `NewBaseCurrency`
  - Сохранять в БД задачу `CacheTask` на выполнение пересчета. В задаче должна сохраняться новая базовая валюта `NewBaseCurrency`
  - Добавлять статус задачи `Создана`
  - Отправлять задачу во внутреннюю очередь
  - Возвращать из метода REST-Api идентификатор созданной `CacheTask`, статус код ответа = Accepted 
- Реализовать внутреннюю очередь в виде фоновой задачи
  - Очередь должна ожидать поступающих заданий 
  - При поступлении новой задачи получать из DI сервис для обработки данной задачи
  - Вызывать метод сервиса для обработки задачи
  - При старте приложения фоновая задача должна получать из БД задачи в неокончательном статусе (статус отличный от `Завершена успешно`, `Завершена с ошибкой` и `Отменена`)
    - Если задач несколько, последнюю по дате добавления отправлять в очередь, остальным присваивать статус `Отменена`
    - Если задача одна - добавлять ее в очередь на обработку
    - Если задач нет - ничего не делать
- Реализовать сервис для пересчета кэша
  - Принимает на вход идентификатор задачи на выполнение
  - Получает из БД задачу `CacheTask` и из нее значение новой базовой валюты
  - Устанавливает задаче статус `В обработке` и сохраняет его в БД
  - Получает из базы значения кэша, сгруппированные по дате актуальности
  - Пересчитывает значение валюты по алгоритму, описанному в предыдущем задании
  - Сохраняет новые данные кэша
  - Сохраняет значение новой базовой валюты, чтобы новые запросы к апи уходили с данным значением
  - Помечает задачу как успешно завершенную
  - Если во время выполнения пересчета кэша случилась ошибка - помечает задачу как зачершенную с ошибкой и логирует ошибку
- Доработать сервис `ICachedCurrencyAPI`
  - Если кэш не протух (дата актуальности кэша соответствует запросу), то вернуть данные из кэша
  - Если кэш протух и в базе есть задача `CacheTask` в статусе `В обработке` или `Создана`, то подождать 10 секунд. 
    - Если после ожидания в БД все еще есть задача `CacheTask` в статусе `В обработке` или `Создана`, то вернуть ошибку. 
    - Если после ожидания все задачи обработались, то вызвать внеший АПИ, добавить значения в кэш и вернуть данные 
  - Если кэш протух и в базе нет задачи `CacheTask` в статусе `В обработке`, то вызвать внеший АПИ, добавить значения в кэш и вернуть данные
